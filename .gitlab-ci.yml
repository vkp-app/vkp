variables:
  BP_OCI_SOURCE: https://github.com/vkp-app/vkp
  CNB_TAGS: "0.0.8"
  KANIKO_TAGS: $CNB_TAGS
  IMG_TAGS: $CNB_TAGS

stages:
  - build
  - pre-deploy
  - deploy

build apiserver:
  extends: .auto-build
  stage: build
  variables:
    AUTO_CNB_RUN_IMAGE: harbor.dcas.dev/docker.io/paketobuildpacks/run:tiny-cnb
    PROJECT_PATH: apiserver
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - changes:
      - apiserver/**/*
      - .gitlab-ci.yml

build plugin-hooks:
  extends: .auto-build
  stage: build
  variables:
    AUTO_CNB_RUN_IMAGE: harbor.dcas.dev/docker.io/paketobuildpacks/run:tiny-cnb
    PROJECT_PATH: vcluster-plugin-hooks
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - changes:
        - vcluster-plugin-hooks/**/*
        - .gitlab-ci.yml

build plugin-sync:
  stage: build
  image: harbor.dcas.dev/registry.gitlab.com/av1o/base-images/go-git:1.19
  variables:
    PROJECT_PATH: vcluster-plugin-sync
    KO_DOCKER_REPO: "$CI_REGISTRY_IMAGE/vcluster-plugin-sync"
  script:
    - cd "$PROJECT_PATH"
    - |
      wget -O ko.tar.gz https://github.com/ko-build/ko/releases/download/v0.12.0/ko_0.12.0_Linux_x86_64.tar.gz
      tar -xvf ko.tar.gz
      chmod +x ./ko
    - echo "$CI_REGISTRY_PASSWORD" | ./ko login --username="$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - ./ko build --bare -t "$CNB_TAGS" "./cmd/sync"
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - changes:
        - vcluster-plugin-sync/**/*
        - .gitlab-ci.yml

build web:
  stage: build
  extends: .auto-build
  dependencies: []
  variables:
    AUTO_CNB_BUILD_IMAGE: "${AUTO_DEVOPS_REGISTRY_GITLAB}registry.gitlab.com/autokubeops/buildpacks/lifecycle:0.3"
    AUTO_CNB_RUN_IMAGE: harbor.dcas.dev/docker.io/paketobuildpacks/run:tiny-cnb
    PROJECT_PATH: web
    BP_STATIC_DIR: build
    BP_NODE_OUTPUT_DIR: build
    BP_NODE_VERSION: "~16"
    BP_STATIC_ENV: .env
    BP_KEEP_FILES: .env
  script:
    - ${AUTO_CNB_BUILD_ENV_VARS} /main
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - changes:
        - web/**/*
        - .gitlab-ci.yml

build operator:
  extends: .auto-build
  stage: build
  variables:
    AUTO_CNB_RUN_IMAGE: harbor.dcas.dev/docker.io/paketobuildpacks/run:tiny-cnb
    PROJECT_PATH: operator
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - changes:
        - operator/**/*
        - .gitlab-ci.yml

build bundle:
  stage: build
  extends: .kaniko
  dependencies: []
  needs: []
  variables:
    KANIKO_DOCKERFILE: bundle.Dockerfile
    KANIKO_CONTEXT: "$CI_PROJECT_DIR/operator"
  before_script:
    - export CI_REGISTRY_IMAGE="$CI_REGISTRY_IMAGE/bundle"
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - when: on_success

prepare index:
  stage: pre-deploy
  dependencies: []
  needs:
    - job: build bundle
    - job: build operator
      optional: true
  image:
    name: quay.io/operator-framework/upstream-registry-builder
    entrypoint: [""]
  script:
    - |
      mkdir -p ~/.docker
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > ~/.docker/config.json
    - cd operator/
    - |
      if [ -z ${FIRST_RUN+x} ]; then
        opm index add --bundles "$CI_REGISTRY_IMAGE/bundle:$CI_COMMIT_SHORT_SHA" --from-index "$CI_REGISTRY_IMAGE/index:main" --mode semver-skippatch --generate
      else
        opm index add --bundles "$CI_REGISTRY_IMAGE/bundle:$CI_COMMIT_SHORT_SHA" --mode semver-skippatch --generate
      fi
  artifacts:
    paths:
      - operator/database/index.db
      - operator/index.Dockerfile
  rules:
    - if: "$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH"
      when: never
    - when: on_success

build index:
  stage: deploy
  extends: .kaniko
  dependencies:
    - prepare index
  needs:
    - prepare index
  variables:
    KANIKO_DOCKERFILE: index.Dockerfile
    KANIKO_CONTEXT: operator
  before_script:
    - export CI_REGISTRY_IMAGE="$CI_REGISTRY_IMAGE/index"

include:
  - remote: 'https://gitlab.com/av1o/gitlab-ci-templates/-/raw/master/build/CNB.gitlab-ci.yml'
  - remote: 'https://gitlab.com/av1o/gitlab-ci-templates/-/raw/master/build/Kaniko.gitlab-ci.yml'
